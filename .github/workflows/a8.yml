name: CI/CD to EC2 (Spring Boot + Expo web)

on:
  push:
    branches: [ main, luca ]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  RN_DIR: '.'          # Project root containing package.json
  SERVER_DIR: 'server' # Spring Boot module with pom.xml

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install JS deps (npm)
        working-directory: ${{ env.RN_DIR }}
        run: npm ci --no-audit --no-fund

      # ---- KEY FIX: fresh Expo web export into Spring static ----
      - name: Export Expo web into Spring static (fresh)
        working-directory: ${{ env.RN_DIR }}
        env:
          EXPO_NO_PROMPT: '1'
          EXPO_NO_TELEMETRY: '1'
        shell: bash
        run: |
          set -euxo pipefail
          # 1) remove stale hashed files so index.html can't point to old bundles
          rm -rf "${{ env.SERVER_DIR }}/src/main/resources/static"
          mkdir -p "${{ env.SERVER_DIR }}/src/main/resources/static"

          # 2) fresh export
          npx --yes expo export --platform web --clear \
            --output-dir "${{ env.SERVER_DIR }}/src/main/resources/static"

          # 3) version marker to verify after deploy
          echo "built $(date -Is) sha ${GITHUB_SHA::7}" \
            > "${{ env.SERVER_DIR }}/src/main/resources/static/_version.txt"

          # 4) quick sanity print
          test -f "${{ env.SERVER_DIR }}/src/main/resources/static/index.html"
          ls -l "${{ env.SERVER_DIR }}/src/main/resources/static" | head -n 50 || true

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: 'maven'

      - name: Build Spring Boot JAR (clean)
        working-directory: ${{ env.SERVER_DIR }}
        run: |
          chmod +x mvnw || true
          ./mvnw -q -DskipTests clean package || mvn -q -DskipTests clean package
          ls -l target

      - name: Verify JAR contains new web build marker
        working-directory: ${{ env.SERVER_DIR }}
        shell: bash
        run: |
          set -euxo pipefail
          JAR=$(ls -1 target/*.jar | head -1)
          echo "JAR=$JAR"
          unzip -p "$JAR" BOOT-INF/classes/static/_version.txt | tee /tmp/version.txt
          grep -q "${GITHUB_SHA::7}" /tmp/version.txt

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: ${{ env.SERVER_DIR }}/target/*.jar
          if-no-files-found: error

  deploy-ec2:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download built JAR
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: ./dist

      - name: Ensure deploy dir & stop service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euxo pipefail
            mkdir -p "/home/${{ secrets.EC2_USER }}/deploy"
            sudo systemctl stop "${{ secrets.SERVICE_NAME }}" || true

      - name: Copy JAR to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "./dist/*.jar"
          target: "/home/${{ secrets.EC2_USER }}/deploy/"

      - name: List remote deploy dir (debug)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euxo pipefail
            ls -lah "/home/${{ secrets.EC2_USER }}/deploy" || true

      - name: Point service to newest JAR & restart (robust)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euxo pipefail
            APP_DIR="/home/${{ secrets.EC2_USER }}/deploy"
            SVC="${{ secrets.SERVICE_NAME }}"

            echo "== Remote JARs (timestamps) =="
            ls -lt "$APP_DIR"/*.jar || true

            # Pick latest **versioned** JAR, explicitly excluding app.jar
            LATEST="$(ls -1t "$APP_DIR"/*.jar 2>/dev/null | grep -v '/app\.jar$' | head -1 || true)"
            if [ -z "$LATEST" ]; then
              # Fallback: if for some reason only app.jar exists, use it
              LATEST="$(ls -1t "$APP_DIR"/*.jar 2>/dev/null | head -1 || true)"
            fi
            test -n "$LATEST" || { echo "No JAR files found in $APP_DIR"; exit 1; }
            echo "LATEST=$LATEST"

            # Update the symlink atomically
            ln -sfn "$LATEST" "$APP_DIR/app.jar"
            echo "Now using $(readlink -f "$APP_DIR/app.jar")"

            # Restart and wait until service is active
            sudo systemctl daemon-reload || true
            sudo systemctl restart "$SVC" || sudo systemctl start "$SVC" || true

            for i in $(seq 1 60); do
              if sudo systemctl is-active --quiet "$SVC"; then
                echo "Service is active"
                break
              fi
              echo "Waiting for service to be active... ($i/60)"
              sleep 1
            done
            sudo systemctl is-active --quiet "$SVC" || { echo "Service failed to become active"; sudo systemctl status "$SVC" --no-pager || true; exit 1; }

            # Verify the running app serves our new marker (commit SHA)
            for i in $(seq 1 15); do
              MARKER="$(curl -fsS http://127.0.0.1:8080/_version.txt || true)"
              echo "marker: $MARKER"
              if echo "$MARKER" | grep -q "${GITHUB_SHA::7}"; then
                echo "Version marker OK"
                exit 0
              fi
              sleep 1
            done

            echo "ERROR: server still on old build or marker missing"
            curl -sS http://127.0.0.1:8080/ | head -n 30 || true
            exit 1

      - name: Show logs on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo systemctl status "${{ secrets.SERVICE_NAME }}" --no-pager || true
            sudo journalctl -u "${{ secrets.SERVICE_NAME }}" -n 200 --no-pager || true
