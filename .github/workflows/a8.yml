name: CI/CD to EC2 (Spring Boot + Expo web)

on:
  push:
    branches: [ main, luca ]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  RN_DIR: '.'          # Project root with package.json
  SERVER_DIR: 'server' # Spring Boot module with pom.xml

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install JS deps (npm)
        working-directory: ${{ env.RN_DIR }}
        run: npm ci --no-audit --no-fund

      # ---- KEY FIX: always export a fresh Expo web build into Spring static ----
      - name: Export Expo web into Spring static (fresh)
        working-directory: ${{ env.RN_DIR }}
        env:
          EXPO_NO_PROMPT: '1'
          EXPO_NO_TELEMETRY: '1'
        shell: bash
        run: |
          set -euxo pipefail
          rm -rf "${{ env.SERVER_DIR }}/src/main/resources/static"
          mkdir -p "${{ env.SERVER_DIR }}/src/main/resources/static"

          npx --yes expo export --platform web --clear \
            --output-dir "${{ env.SERVER_DIR }}/src/main/resources/static"

          echo "built $(date -Is) sha ${GITHUB_SHA::7}" \
            > "${{ env.SERVER_DIR }}/src/main/resources/static/_version.txt"

          test -f "${{ env.SERVER_DIR }}/src/main/resources/static/index.html"
          ls -l "${{ env.SERVER_DIR }}/src/main/resources/static" | head -n 50 || true

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: 'maven'

      - name: Build Spring Boot JAR (clean)
        working-directory: ${{ env.SERVER_DIR }}
        run: |
          chmod +x mvnw || true
          ./mvnw -q -DskipTests clean package || mvn -q -DskipTests clean package
          ls -l target

      - name: Verify JAR contains _version marker
        working-directory: ${{ env.SERVER_DIR }}
        shell: bash
        run: |
          set -euxo pipefail
          JAR=$(ls -1 target/*.jar | head -1)
          echo "JAR=$JAR"
          unzip -p "$JAR" BOOT-INF/classes/static/_version.txt | tee /tmp/version.txt
          grep -q "${GITHUB_SHA::7}" /tmp/version.txt

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: ${{ env.SERVER_DIR }}/target/*.jar
          if-no-files-found: error

  deploy-ec2:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download built JAR
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: ./dist

      - name: List downloaded artifact (debug)
        run: ls -R ./dist || true

      # ---- NEW: flatten the jar(s) to a predictable folder ----
      - name: Gather JAR(s) to upload
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p to-upload
          found="$(find dist -type f -name '*.jar' -print)"
          echo "$found" | sed -n '1,200p'
          test -n "$found" || { echo "No JARs found under ./dist"; exit 1; }
          # copy all jars into to-upload/
          while IFS= read -r f; do cp -f "$f" to-upload/; done <<< "$found"
          ls -l to-upload

      - name: Ensure deploy dir & stop service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euxo pipefail
            mkdir -p "/home/${{ secrets.EC2_USER }}/deploy"
            sudo systemctl stop "${{ secrets.SERVICE_NAME }}" || true

      - name: Copy JAR to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "./to-upload/*.jar"
          target: "/home/${{ secrets.EC2_USER }}/deploy/"

      - name: Point service to newest JAR & restart (robust)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euxo pipefail
            APP_DIR="/home/${{ secrets.EC2_USER }}/deploy"
            SHA_SHORT="${{ github.sha }}"
            SHA_SHORT="${SHA_SHORT::7}"

            echo "== Remote JARs (timestamps) =="
            ls -lt "$APP_DIR"/*.jar || true

            # newest REAL jar (exclude the app.jar symlink if present)
            LATEST="$(ls -1t "$APP_DIR"/*.jar 2>/dev/null | grep -v '/app\.jar$' | head -1 || true)"
            if [ -z "${LATEST:-}" ] && [ -L "$APP_DIR/app.jar" ]; then
              LATEST="$(readlink -f "$APP_DIR/app.jar" || true)"
            fi
            [ -n "${LATEST:-}" ] || { echo "No JAR found in $APP_DIR"; exit 1; }

            ln -sfn "$LATEST" "$APP_DIR/app.jar"
            echo "Now using $(readlink -f "$APP_DIR/app.jar")"

            sudo systemctl daemon-reload || true
            sudo systemctl restart "${{ secrets.SERVICE_NAME }}" || sudo systemctl start "${{ secrets.SERVICE_NAME }}"

            # wait for service to become active
            for i in {1..30}; do
              if sudo systemctl is-active --quiet "${{ secrets.SERVICE_NAME }}"; then
                echo "Service is active"; break
              fi
              echo "Waiting for service to become active... ($i)"
              sleep 2
            done
            sudo systemctl is-active --quiet "${{ secrets.SERVICE_NAME }}" || { echo "Service failed to become active"; exit 1; }

            # wait for app to serve the new version marker
            OK=""
            for i in {1..30}; do
              MARKER="$(curl -fsS http://127.0.0.1:8080/_version.txt || true)"
              echo "marker($i): $MARKER"
              if echo "$MARKER" | grep -q "$SHA_SHORT"; then OK="yes"; break; fi
              sleep 2
            done
            [ "$OK" = "yes" ] || { echo "ERROR: server still on old build or marker missing"; exit 1; }

      - name: Show logs on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo systemctl status "${{ secrets.SERVICE_NAME }}" --no-pager || true
            sudo journalctl -u "${{ secrets.SERVICE_NAME }}" -n 400 --no-pager || true
